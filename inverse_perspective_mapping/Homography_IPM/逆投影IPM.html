<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>逆投影IPM</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><div align="center"><font size="5">基于俯仰角补偿的单应性矩阵逆投影</font></div>
<p><br></p>
<h2><a id="1_3"></a>1.什么是逆投影？</h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在自动/辅助驾驶中，在前视摄像头拍摄的图像中，由于透视效应的存在，本来平行的事物，在图像中确实相交的。而IPM变换就是消除这种透视效应，所以也叫逆透视。逆投影将摄像头拍摄的图像进行转换成鸟瞰图，本质上是二维平面到二维平面的转换。通过图像上的一个点，可以估计其真实位置。</p>
<p><img src="https://img-blog.csdnimg.cn/20210719183842502.png#pic_center" alt="在这里插入图片描述"><br>
<br></p>
<h2><a id="2Homography_8"></a>2.单应性矩阵(Homography)</h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在计算机视觉中，平面的单应性被定义为一个平面到另外一个平面的投影映射。因此一个二维平面上的点映射到摄像机CCD上的映射就是平面单应性的例子。如果相机cmos平面上的点到某一平面的映射使用齐次坐标，这种映射可以用矩阵相乘的方式表示，这个矩阵就是单应性矩阵。<br>
<img src="https://img-blog.csdnimg.cn/20210719184331236.png#pic_center" alt="在这里插入图片描述"><br>
其中单应性矩阵为H(3x3矩阵)，由于单应性矩阵能进行归一化，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext mathvariant="italic">H</mtext><mn>33</mn></msub></mrow><annotation encoding="application/x-tex">\textit{H}_{33}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord text"><span class="mord textit">H</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> = 1，<br>
<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext mathvariant="italic">x</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\textit{x}_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord text"><span class="mord textit">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>, <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext mathvariant="italic">y</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\textit{y}_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6747em; vertical-align: -0.24414em;"></span><span class="mord"><span class="mord text"><span class="mord textit">y</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.217524em;"><span class="" style="top: -2.45586em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.24414em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为图像上的点位置，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mtext mathvariant="italic">x</mtext><mi>i</mi><msup><mrow></mrow><mo mathvariant="normal">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">\textit{x}_{i}^{'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.20114em; vertical-align: -0.258664em;"></span><span class="mord"><span class="mord text"><span class="mord textit">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94248em;"><span class="" style="top: -2.44134em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.827829em;"><span class="" style="top: -2.931em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.258664em;"><span class=""></span></span></span></span></span></span></span></span></span></span>, <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mtext mathvariant="italic">y</mtext><mi>i</mi><msup><mrow></mrow><mo mathvariant="normal">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">\textit{y}_{i}^{'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.20114em; vertical-align: -0.258664em;"></span><span class="mord"><span class="mord text"><span class="mord textit">y</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94248em;"><span class="" style="top: -2.44134em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.827829em;"><span class="" style="top: -2.931em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.258664em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为在逆投影平面的坐标，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext mathvariant="italic">s</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\textit{s}_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord text"><span class="mord textit">s</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为齐次矩阵系数。<br>
<br></p>
<h3><a id="21Homography_15"></a>2.1求解单应性矩阵(Homography）</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单应性矩阵除了<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext mathvariant="italic">H</mtext><mn>33</mn></msub></mrow><annotation encoding="application/x-tex">\textit{H}_{33}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord text"><span class="mord textit">H</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> = 1，还有有八个未知数，求解线性方程组至少需要四组对照点，每组对照点有x和y两个方程，联立所有方程求解。但实际求解单应性矩阵往往会获取多组数据求取迭代解，获得满足所有数据的最小误差解。opnecv提供了函数接口 cv2.findHmoography, 通过RANSAC随机一致性采样处理个别误差较大的数据，最终通过SVD分解计算反投影误差(back-projection error)最小的一组迭代解。如下为反投影误差(back-projection error)表达式：<br>
<img src="https://img-blog.csdnimg.cn/20210719200427391.png#pic_center" alt="在这里插入图片描述"><br>
opencv文档：</p>
<p><img src="https://img-blog.csdnimg.cn/20210719192912647.png#pic_center" alt="在这里插入图片描述"><br>
<br></p>
<h3><a id="22_23"></a>2.2室内标定方案</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将相机置于和船上位置相同高度下，将标定板放置在地面上，通过角点检测获取图像上的点，对于实际上的角点位置可以通过尺子测量得到。由于标定板呈矩形分布，只需要测量四个角落的位置和标定板方格的尺寸既可获取整张图所有角点的位置。为降低测量误差，可以采集多张图像，例如不同尺寸的标定板不同位置的数据，一起求解。</p>
<p><img src="https://img-blog.csdnimg.cn/20210719192647262.png#pic_center" alt="在这里插入图片描述"><br>
<br></p>
<h3><a id="3__28"></a>3. 基于俯仰角补偿的单应性矩阵</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在得到单应性矩阵后，可以对地面上的目标进行位置估计，如上图中的可乐瓶子在右前方(1,1.8)位置左右，逆投影估计的结果误差为3cm，估计误差较低。但当相机发生姿态变换时，尤其时俯仰角的变化，会使得逆投影估计位置的精度瞬间增大，为了降低该误差，需要利用俯仰角补偿单应性矩阵。</p>
<p>基于俯仰角补偿的单应性矩阵如下：<br>
<img src="https://img-blog.csdnimg.cn/20210719201122367.png" alt="在这里插入图片描述"><br>
H为俯仰角为0度标定的单应性矩阵<br>
K为内参矩阵<br>
R为旋转矩阵 绕相机水平方向旋转俯仰角a</p>
<p>补偿原理证明过程如下：<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于标定的单应性矩阵为相机处于0度俯仰时，当相机处于俯仰角a时，首先需要将图像平面旋转-a度到相机平面0度时，相机旋转通过单应性矩阵H1 = KRK 实现，证明过程如下图：<br>
<img src="https://img-blog.csdnimg.cn/20210719193639575.png#pic_center" alt="在这里插入图片描述"><br>
绕图像x轴旋转后，将新的图像位置乘以标定后的单应性矩阵H，即可得到最终位置。<br>
<br></p>
<h3><a id="32__43"></a>3.2 逆投影结果</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为验证逆投影估计位置的精度，通过激光雷达获取真实距离，对比相机估计的结果，如下图所示，右边坐标系红点为根据相机上的检测的水岸分界线逆投影得到的位置，蓝点为激光雷达的真实距离。对比发现经过俯仰角弥补后，远处的点位置估计不会发生较大误差。<br>
<img src="https://img-blog.csdnimg.cn/20210719201328840.png?#pic_center" alt="在这里插入图片描述"></p>
<h3><a id="4_47"></a>4.参考资料</h3>
<ol>
<li>http://www.opencv.org.cn/opencvdoc/2.3.2/html/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html?highlight=homography#cv2.findHomography</li>
<li>https://www.cnblogs.com/wangguchangqing/p/8287585.html#autoid-1-1-0</li>
</ol>
</div>
</body>

</html>
